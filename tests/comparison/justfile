# Autoware NDT Comparison Testing
#
# This justfile manages the patched autoware_ndt_scan_matcher for comparison testing.
# Run from project root with: just run-builtin, just dump-voxels-autoware, etc.

# Project root (two levels up)
project_root := "../../"

# Autoware activation script
autoware_activate := project_root + "scripts/activate_autoware.sh"

# Package source directory (submodule)
ndt_package := "autoware_core/localization/autoware_ndt_scan_matcher"

# Build directories (local to this comparison folder)
build_dir := "build"
install_dir := "install"


# Show available recipes
default:
    @just --list

# === Build ===

# Build the patched autoware_ndt_scan_matcher package
build:
    #!/usr/bin/env bash
    set -eo pipefail
    source {{autoware_activate}}
    echo "Building autoware_ndt_scan_matcher from submodule..."
    colcon build \
        --base-paths {{ndt_package}} \
        --build-base {{build_dir}} \
        --install-base {{install_dir}} \
        --symlink-install \
        --cmake-args -DCMAKE_BUILD_TYPE=Release
    echo "Build complete."

# Clean build artifacts
clean:
    rm -rf {{build_dir}} {{install_dir}} log

# === Run Autoware Builtin NDT ===

# Start Autoware builtin NDT demo (simulation + rosbag + recording)
run:
    #!/usr/bin/env bash
    set -eo pipefail
    cd {{project_root}}
    ./scripts/run_demo.sh \
        "$(realpath data/sample-map)" \
        "$(realpath data/sample-rosbag-fixed)" \
        "rosbag"

# Run Autoware with full debug output (requires build first)
# - NDT_DEBUG: enables alignment and pose init debug in ndt_scan_matcher_core.cpp
# - NDT_AUTOWARE_DEBUG: enables per-iteration debug in multigrid_ndt_omp_impl.hpp
run-debug:
    #!/usr/bin/env bash
    set -eo pipefail
    cd {{project_root}}
    mkdir -p logs
    NDT_DEBUG=1 \
    NDT_DEBUG_FILE=logs/ndt_autoware_debug.jsonl \
    NDT_AUTOWARE_DEBUG=1 \
    NDT_AUTOWARE_DEBUG_FILE=logs/ndt_autoware_iterations.jsonl \
        ./scripts/run_demo.sh \
            "$(realpath data/sample-map)" \
            "$(realpath data/sample-rosbag-fixed)" \
            "rosbag"

# Run Autoware with profiling only (timing data, minimal overhead)
# Only enables alignment-level debug without per-iteration data
run-profiling:
    #!/usr/bin/env bash
    set -eo pipefail
    cd {{project_root}}
    mkdir -p logs
    NDT_DEBUG=1 \
    NDT_DEBUG_FILE=logs/ndt_autoware_profiling.jsonl \
        ./scripts/run_demo.sh \
            "$(realpath data/sample-map)" \
            "$(realpath data/sample-rosbag-fixed)" \
            "rosbag"

# === Debug Data Collection ===

# Dump voxel grid data from Autoware (requires build first)
dump-voxels:
    #!/usr/bin/env bash
    set -eo pipefail
    cd {{project_root}}
    mkdir -p logs
    NDT_DUMP_VOXELS=1 \
    NDT_DUMP_VOXELS_FILE=logs/ndt_autoware_voxels.json \
        ./scripts/run_demo.sh \
            "$(realpath data/sample-map)" \
            "$(realpath data/sample-rosbag-fixed)" \
            "rosbag"

# Analyze Autoware debug output (alignment and pose init)
analyze-debug:
    #!/usr/bin/env bash
    cd {{project_root}}
    python3 tmp/analyze_debug.py logs/ndt_autoware_debug.jsonl

# Analyze Autoware per-iteration debug output
analyze-iterations:
    #!/usr/bin/env bash
    cd {{project_root}}
    python3 tmp/analyze_debug.py logs/ndt_autoware_iterations.jsonl

# === Submodule Management ===

# Show git status of the submodule
status:
    @echo "Submodule status:"
    @cd autoware_core && git log -1 --oneline
    @cd autoware_core && git status -s

# Update submodule to latest
update:
    git submodule update --remote autoware_core
