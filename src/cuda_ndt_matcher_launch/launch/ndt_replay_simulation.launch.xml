<?xml version="1.0"?>
<launch>
  <!-- NDT Replay Simulation
       Based on Autoware's autoware.launch.xml with minimal components for NDT testing.

       Both modes use autoware.launch.xml with launch_localization=false, then include
       the localization stack separately to enable passing user_defined_initial_pose.

       For Autoware mode: Uses tier4_localization_component with standard NDT
       For CUDA mode: Uses cuda_localization with our CUDA NDT implementation
  -->

  <!-- Global parameters - must be set before any nodes are launched -->
  <set_parameter name="use_sim_time" value="true"/>

  <!-- Implementation Selection -->
  <arg name="use_cuda" default="false" description="Use CUDA NDT matcher (true) or Autoware original (false)"/>

  <!-- Map and data paths -->
  <arg name="map_path" description="Directory containing pointcloud_map.pcd and lanelet2_map.osm"/>
  <arg name="vehicle_model" default="sample_vehicle"/>
  <!-- Use rosbag_sensor_kit which has 3 LiDARs (top, left, right) matching the sample rosbag -->
  <arg name="sensor_model" default="rosbag_sensor_kit"/>
  <arg name="lanelet2_map_file" default="lanelet2_map.osm"/>
  <arg name="pointcloud_map_file" default="pointcloud_map.pcd"/>

  <!-- RViz -->
  <arg name="rviz" default="true"/>

  <!-- User-defined initial pose (for headless testing without RViz) -->
  <!-- Format: [x, y, z, qx, qy, qz, qw] in map frame -->
  <!-- Default values are for sample-rosbag at approximate starting position -->
  <!-- Note: z=-3.3 matches the actual vehicle height in the sample rosbag -->
  <arg name="user_defined_initial_pose_enable" default="false"/>
  <arg name="user_defined_initial_pose" default="[89571.0, 42301.0, -3.3, 0.0, 0.0, 0.28, 0.96]"/>

  <!-- CUDA NDT parameter file -->
  <arg name="ndt_param_file" default="$(find-pkg-share cuda_ndt_matcher_launch)/config/ndt_scan_matcher.param.yaml"/>

  <!-- Common disabled components -->
  <let name="disabled_components" value="true"/>

  <!-- ========== Autoware Mode ========== -->
  <!-- Calls autoware.launch.xml with launch_localization=false, then includes
       localization separately to enable passing initial_pose -->
  <group unless="$(var use_cuda)">
    <!-- Autoware stack without localization (we provide our own with initial_pose) -->
    <include file="$(find-pkg-share autoware_launch)/launch/autoware.launch.xml">
      <arg name="map_path" value="$(var map_path)"/>
      <arg name="vehicle_model" value="$(var vehicle_model)"/>
      <arg name="sensor_model" value="$(var sensor_model)"/>
      <arg name="lanelet2_map_file" value="$(var lanelet2_map_file)"/>
      <arg name="pointcloud_map_file" value="$(var pointcloud_map_file)"/>
      <!-- Modules to launch -->
      <arg name="launch_map" value="true"/>
      <arg name="launch_sensing" value="true"/>
      <arg name="launch_localization" value="false"/>
      <arg name="launch_vehicle" value="true"/>
      <arg name="launch_system" value="false"/>
      <arg name="launch_perception" value="false"/>
      <arg name="launch_planning" value="false"/>
      <arg name="launch_control" value="false"/>
      <arg name="launch_api" value="false"/>
      <!-- Logging simulation mode settings -->
      <arg name="use_sim_time" value="true"/>
      <arg name="system_run_mode" value="logging_simulation"/>
      <arg name="launch_sensing_driver" value="false"/>
      <!-- RViz -->
      <arg name="rviz" value="$(var rviz)"/>
    </include>

    <!-- Autoware localization stack with initial_pose support -->
    <!-- When user_defined_initial_pose_enable is true, pass the initial pose; otherwise pass empty list -->
    <let name="autoware_initial_pose" value="$(var user_defined_initial_pose)" if="$(var user_defined_initial_pose_enable)"/>
    <let name="autoware_initial_pose" value="[]" unless="$(var user_defined_initial_pose_enable)"/>
    <include file="$(find-pkg-share autoware_launch)/launch/components/tier4_localization_component.launch.xml">
      <arg name="initial_pose" value="$(var autoware_initial_pose)"/>
    </include>
  </group>

  <!-- ========== CUDA Mode ========== -->
  <!-- Calls autoware.launch.xml with launch_localization=false, then includes our CUDA localization stack -->
  <group if="$(var use_cuda)">
    <!-- Autoware stack without localization (we provide our own CUDA implementation) -->
    <include file="$(find-pkg-share autoware_launch)/launch/autoware.launch.xml">
      <arg name="map_path" value="$(var map_path)"/>
      <arg name="vehicle_model" value="$(var vehicle_model)"/>
      <arg name="sensor_model" value="$(var sensor_model)"/>
      <arg name="lanelet2_map_file" value="$(var lanelet2_map_file)"/>
      <arg name="pointcloud_map_file" value="$(var pointcloud_map_file)"/>
      <!-- Modules to launch -->
      <arg name="launch_map" value="true"/>
      <arg name="launch_sensing" value="true"/>
      <arg name="launch_localization" value="false"/>
      <arg name="launch_vehicle" value="true"/>
      <arg name="launch_system" value="false"/>
      <arg name="launch_perception" value="false"/>
      <arg name="launch_planning" value="false"/>
      <arg name="launch_control" value="false"/>
      <arg name="launch_api" value="false"/>
      <!-- Logging simulation mode settings -->
      <arg name="use_sim_time" value="true"/>
      <arg name="system_run_mode" value="logging_simulation"/>
      <arg name="launch_sensing_driver" value="false"/>
      <!-- RViz -->
      <arg name="rviz" value="$(var rviz)"/>
    </include>

    <!-- CUDA NDT localization stack -->
    <include file="$(find-pkg-share cuda_ndt_matcher_launch)/launch/cuda_localization.launch.xml">
      <arg name="ndt_param_file" value="$(var ndt_param_file)"/>
      <arg name="user_defined_initial_pose_enable" value="$(var user_defined_initial_pose_enable)"/>
      <arg name="user_defined_initial_pose" value="$(var user_defined_initial_pose)"/>
      <!-- gnss_enabled defaults to true, enabling automatic_pose_initializer -->
    </include>
  </group>
</launch>
