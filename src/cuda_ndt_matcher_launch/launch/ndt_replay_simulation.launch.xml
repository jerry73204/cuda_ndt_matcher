<?xml version="1.0"?>
<launch>
  <!-- NDT Replay Simulation
       Based on Autoware's logging_simulator with minimal components for NDT testing.

       For Autoware mode: Uses logging_simulator with standard NDT
       For CUDA mode: Uses logging_simulator with pose_source=gyro_odom (no NDT),
                      then launches our CUDA NDT separately
  -->

  <!-- Global parameters - must be set before any nodes are launched -->
  <set_parameter name="use_sim_time" value="true"/>

  <!-- Implementation Selection -->
  <arg name="use_cuda" default="false" description="Use CUDA NDT matcher (true) or Autoware original (false)"/>

  <!-- Map and data paths -->
  <arg name="map_path" description="Directory containing pointcloud_map.pcd and lanelet2_map.osm"/>
  <arg name="vehicle_model" default="sample_vehicle"/>
  <!-- Use rosbag_sensor_kit which has 3 LiDARs (top, left, right) matching the sample rosbag -->
  <arg name="sensor_model" default="rosbag_sensor_kit"/>
  <arg name="lanelet2_map_file" default="lanelet2_map.osm"/>
  <arg name="pointcloud_map_file" default="pointcloud_map.pcd"/>

  <!-- RViz -->
  <arg name="rviz" default="true"/>

  <!-- CUDA NDT parameter file -->
  <arg name="ndt_param_file" default="$(find-pkg-share cuda_ndt_matcher_launch)/config/ndt_scan_matcher.param.yaml"/>

  <!-- Common disabled components -->
  <let name="disabled_components" value="true"/>

  <!-- ========== Autoware Mode ========== -->
  <group unless="$(var use_cuda)">
    <include file="$(find-pkg-share autoware_launch)/launch/logging_simulator.launch.xml">
      <arg name="map_path" value="$(var map_path)"/>
      <arg name="vehicle_model" value="$(var vehicle_model)"/>
      <arg name="sensor_model" value="$(var sensor_model)"/>
      <arg name="lanelet2_map_file" value="$(var lanelet2_map_file)"/>
      <arg name="pointcloud_map_file" value="$(var pointcloud_map_file)"/>
      <arg name="map" value="true"/>
      <arg name="sensing" value="true"/>
      <arg name="localization" value="true"/>
      <arg name="vehicle" value="true"/>
      <arg name="system" value="false"/>
      <arg name="perception" value="false"/>
      <arg name="planning" value="false"/>
      <arg name="control" value="false"/>
      <arg name="rviz" value="$(var rviz)"/>
    </include>
  </group>

  <!-- ========== CUDA Mode ========== -->
  <!-- Uses logging_simulator WITHOUT localization, then includes our CUDA localization stack -->
  <group if="$(var use_cuda)">
    <!-- Autoware stack without localization (we provide our own) -->
    <include file="$(find-pkg-share autoware_launch)/launch/logging_simulator.launch.xml">
      <arg name="map_path" value="$(var map_path)"/>
      <arg name="vehicle_model" value="$(var vehicle_model)"/>
      <arg name="sensor_model" value="$(var sensor_model)"/>
      <arg name="lanelet2_map_file" value="$(var lanelet2_map_file)"/>
      <arg name="pointcloud_map_file" value="$(var pointcloud_map_file)"/>
      <arg name="map" value="true"/>
      <arg name="sensing" value="true"/>
      <arg name="localization" value="false"/>
      <arg name="vehicle" value="true"/>
      <arg name="system" value="false"/>
      <arg name="perception" value="false"/>
      <arg name="planning" value="false"/>
      <arg name="control" value="false"/>
      <arg name="rviz" value="$(var rviz)"/>
    </include>

    <!-- CUDA NDT localization stack -->
    <include file="$(find-pkg-share cuda_ndt_matcher_launch)/launch/cuda_localization.launch.xml">
      <arg name="ndt_param_file" value="$(var ndt_param_file)"/>
      <arg name="gnss_enabled" value="false"/>
    </include>
  </group>
</launch>
